pipeline {
    agent any

    environment {
        NODE_HOME = "C:\\Program Files\\nodejs"
        PATH = "${env.NODE_HOME};${env.PATH}"
        IIS_SITE_NAME = "ngrx-project" // Your IIS site name
        DEPLOY_ROOT = "C:\\inetpub\\wwwroot\\ngrx-project"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/main']],
                          userRemoteConfigs: [[url: 'https://github.com/GaurShankarGope/My-First-Jenkin-project.git']]])
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm install'
            }
        }

        stage('Build Angular Project') {
            steps {
                bat 'npm run build -- --configuration production'
            }
        }

        stage('Deploy to IIS') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMdd-HHmmss")
                    def targetPath = "${DEPLOY_ROOT}\\build-${timestamp}"
                    
                    echo "Creating deployment folder: ${targetPath}"
                    bat "mkdir \"${targetPath}\""

                    echo "Copying files to IIS..."
                    bat "robocopy \"${WORKSPACE}\\dist\\ngrx-project\" \"${targetPath}\" /E /NFL /NDL /NJH /NJS /nc /ns /np"

                    echo "Updating IIS site..."
                    powershell """
                        Import-Module WebAdministration
                        Set-ItemProperty 'IIS:\\Sites\\${IIS_SITE_NAME}' -Name physicalPath -Value '${targetPath}'
                        Restart-WebAppPool '${IIS_SITE_NAME}'
                        Write-Host 'IIS site updated successfully!'
                    """
                }
            }
        }

        stage('Cleanup Old Builds') {
            steps {
                script {
                    echo "Cleaning up old deployments (keeping last 5)..."
                    // Use pure bat commands to safely delete old folders on Windows
                    bat """
                        setlocal enabledelayedexpansion
                        set count=0
                        for /f "tokens=*" %%D in ('dir /b /ad /o-d "${DEPLOY_ROOT}\\build-*"') do (
                            set /a count+=1
                            if !count! gtr 5 (
                                echo Deleting old build: %%D
                                rmdir /s /q "${DEPLOY_ROOT}\\%%D"
                            )
                        )
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Build and deployment completed successfully!'
        }
        failure {
            echo 'Build or deployment failed!'
        }
    }
}
